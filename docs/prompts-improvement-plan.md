# План улучшения промптов CrewAI (SOCANA)

_Составлен: 2026-02-04_

## Что анализировалось

Файл `soc_core/prompts.yaml` — конфигурация "персон" и задач для 3 агентов CrewAI:
- `analyst` — оценка риска и корреляции
- `researcher` — threat intelligence (MITRE + Kaspersky)
- `dispatcher` — формирование итогового Telegram-отчёта

---

## Выявленные проблемы

### 1. Хардкод имён узлов в `analyst.backstory`

Текущий backstory содержит конкретные имена: `AVEVA-7950X`, `DC-NFS`.
Это делает промпт "хрупким": при появлении новых серверов агент не распознает их как цели атаки.

**Решение:** описать логику определения Lateral Movement через роли активов
(`asset_type`: SERVER / WORKSTATION / UNCLASSIFIED), которые уже передаются агенту в `base_ctx`.

### 2. Нет явной обработки статуса Blocked vs Detected

Поле `result` (из `base_ctx`) содержит результат срабатывания антивируса, но текущий
промпт analyst его не использует. Пропускается важное различие: угроза нейтрализована
или активна.

**Решение:** добавить в `analyst.backstory` явную инструкцию про поле `result`.

### 3. Слабые/короткие `tasks.*_suffix`

Текущие суффиксы (`"SOC analysis:"`, `"Telegram report:"`) — слишком краткие ярлыки.
Они не дают агенту чёткой инструкции, что именно сделать в этом вызове.

**Решение:** сделать суффиксы конкретными инструкциями на действие.

---

## Что НЕ реализуется (с объяснением)

### Промежуточный JSON между агентами
CrewAI передаёт результаты как текст. Просить модели возвращать JSON — ненадёжно:
частые опечатки, markdown-обёртки, нужен дополнительный парсер в коде.
Не даёт ощутимой выгоды при текущей архитектуре.

### Переменные `{raw_event}` / `{threat_name}` в YAML
Сейчас нет механизма `.format()` подстановки данных события в YAML-description.
Строки придут агенту буквально как `{raw_event}`. Требует правок в `agents.py`.
Отложено на Уровень 3.

---

## Уровни реализации

### Уровень 1 — только `soc_core/prompts.yaml` (без изменений кода)

**Статус: ВЫПОЛНЕНО**

Что изменено:
- `analyst.role/goal/backstory`: убраны имена узлов, добавлена логика через `asset_type` и поле `result`
- `researcher.role/goal/backstory`: роль CTI-специалиста, инструкция про Securelist/Encyclopedia Kaspersky
- `dispatcher.role/goal/backstory`: правила Markdown для Telegram, акцент на "5 секунд понял суть"
- `tasks.*_suffix`: конкретные инструкции вместо ярлыков

---

### Уровень 2 — YAML + правки `prompts.py` и `agents.py`

**Статус: ОТЛОЖЕНО**

Что планируется:
- Добавить в `TaskPrompts` (в `prompts.py`) поля `expected_output_analyst`,
  `expected_output_researcher`, `expected_output_dispatcher`
- В `agents.py` использовать эти поля при создании `Task(..., expected_output=...)`
- Это позволит задавать `expected_output` из YAML без правки кода в будущем

Объём: ~10-15 строк в `prompts.py` + 3-4 строки в `agents.py`.

---

### Уровень 3 — Шаблонизация переменных в YAML (опционально)

**Статус: НЕ ЗАПЛАНИРОВАНО**

Добавить механизм `.format(raw_event=..., threat_name=...)` в `agents.py`,
чтобы YAML-description задач мог содержать `{raw_event}` и получать реальные данные.
Полезно только при желании полностью управлять description задач из YAML.

---

## Ключевые файлы

| Файл | Назначение |
|------|-----------|
| `soc_core/prompts.yaml` | Конфиг промптов (редактируется без правок кода) |
| `soc_core/prompts.py` | Pydantic-модели + загрузка YAML с fallback на дефолты |
| `soc_core/agents.py` | Создание CrewAI-агентов и задач, сборка `base_ctx` |
| `soc_core/app.py` | Загрузка промптов и вызов `run_crewai_analysis()` |
| `.env` → `PROMPTS_PATH` | Позволяет подключить внешний YAML вместо `soc_core/prompts.yaml` |
